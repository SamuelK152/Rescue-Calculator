<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Rescue Stop Calculator v2</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        margin: 0;
        padding: 0;
      }
      .container {
        background: #fff;
        max-width: 400px;
        margin: 40px auto;
        padding: 24px 28px;
        border-radius: 8px;
        box-shadow: 0 0 10px #0001;
      }
      h1 {
        text-align: center;
      }
      label {
        display: block;
        margin-top: 16px;
        font-weight: bold;
      }

      input,
      select {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      button {
        margin: 1rem;
        width: 100%;
        padding: 12px;
        background: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }

      #advancedOptions label {
        margin-top: 12px;
      }
      .result {
        margin-top: 24px;
        background: #e9ecef;
        padding: 16px;
        border-radius: 4px;
      }
      .error {
        color: red;
        margin-top: 12px;
      }
      .flex-row {
        display: flex;
        gap: 8px;
      }
      .flex-row > div {
        flex: 1;
      }
      .lColumn {
        margin-right: 16px;
      }
      .rColumn {
        margin-left: 16px;
      }
      .result-bar {
        display: flex;
        margin: 18px 0 12px 0;
        height: 38px;
        border-radius: 4px;
        overflow: hidden;
        border: 1px solid #bbb;
        font-weight: bold;
        font-size: 1.1em;
      }
      .bar-possible {
        background: #cce2ff;
        color: #222;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: width 0.3s;
      }
      .bar-rescue {
        background: #ffd6d6;
        color: #a00;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: width 0.3s;
      }
      .bar-labels {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2px;
        font-size: 0.98em;
        font-weight: bold;
      }
      .centered {
        text-align: center;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Rescue Stop Calculator v2.3</h1>
      <button id="toggleAdvanced" style="width: 100%; margin-bottom: 1rem">
        Show Advanced Options
      </button>
      <div class="flex-row" id="mainInputRow">
        <div style="flex: 1; min-width: 0">
          <label for="remainingStops">Remaining Stops:</label>
          <input type="number" id="remainingStops" min="1" required />
          <div id="sphTpsRow" class="flex-row">
            <div style="flex: 1; min-width: 0" class="lColumn">
              <label for="driverSPH">Driver's Avg SPH:</label>
              <input
                type="number"
                id="driverSPH"
                min="1"
                step="0.1"
                placeholder="i.e. 18"
              />
            </div>
            <div style="flex: 1; min-width: 0" class="rColumn">
              <label for="timePerStop">Avg Time/Stop (min):</label>
              <input
                type="number"
                id="timePerStop"
                min="1"
                step="0.1"
                placeholder="i.e. 3.5"
              />
            </div>
          </div>
        </div>
        <div id="advancedOptions" style="flex: 1; min-width: 0; display: none">
          <label for="stopsBeforeChange">Stops Before Rate Change:</label>
          <input type="number" id="stopsBeforeChange" min="1" />
          <label for="newSPH">New Avg SPH:</label>
          <input
            type="number"
            id="newSPH"
            min="1"
            step="0.1"
            placeholder="i.e. 15"
          />
          <label for="newTimePerStop">New Avg Time/Stop (min):</label>
          <input
            type="number"
            id="newTimePerStop"
            min="1"
            step="0.1"
            placeholder="i.e. 4.0"
          />
        </div>
      </div>

      <label for="nonDeliveryTime">Additional Time (min):</label>
      <input type="text" id="nonDeliveryTime" value="0" />
      <div class="flex-row">
        <label style="margin: auto" for="returnTime"
          >Required Return Time:</label
        >
        <div
          id="returnTimePicker"
          style="
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
          "
        >
          <div
            style="display: flex; flex-direction: column; align-items: center"
          >
            <button type="button" id="hourUp">&#9650;</button>
            <span id="hourDisplay" style="font-size: 1.5em">8</span>
            <button id="hourDown">&#9660;</button>
          </div>
          <span style="font-size: 1.5em">:</span>
          <div
            style="display: flex; flex-direction: column; align-items: center"
          >
            <button type="button" id="minUp">&#9650;</button>
            <span id="minDisplay" style="font-size: 1.5em">15</span>
            <button type="button" id="minDown">&#9660;</button>
          </div>
          <span id="ampmDisplay" style="font-size: 1.2em; margin-left: 8px"
            >PM</span
          >
        </div>
      </div>
      <div class="flex-row">
        <button onclick="calculateFinish()">Calculate</button>
      </div>
      <div style="justify-self: center" id="errorMsg" class="error"></div>
      <div id="result" class="result" style="display: none"></div>
    </div>
    <div style="text-align: center; margin-top: 18px">
      <a href="https://www.youtube.com/watch?v=XfELJU1mRMg" target="_blank">
        Feedback
      </a>
    </div>
    <script>
      // --- Custom Return Time Picker ---
      function pad(n) {
        return n < 10 ? "0" + n : n;
      }
      let hour = 8,
        min = 15,
        ampm = "PM";
      const hourDisplay = document.getElementById("hourDisplay");
      const minDisplay = document.getElementById("minDisplay");
      const ampmDisplay = document.getElementById("ampmDisplay");

      function updateTimeDisplay() {
        hourDisplay.textContent = hour;
        minDisplay.textContent = pad(min);
        ampmDisplay.textContent = ampm;
      }
      function getReturnTime24() {
        let h = hour % 12;
        if (ampm === "PM") h += 12;
        return { h, m: min };
      }
      document.getElementById("hourUp").onclick = function () {
        hour = hour === 12 ? 1 : hour + 1;
        updateTimeDisplay();
      };
      document.getElementById("hourDown").onclick = function () {
        hour = hour === 1 ? 12 : hour - 1;
        updateTimeDisplay();
      };
      document.getElementById("minUp").onclick = function () {
        min += 5;
        if (min >= 60) {
          min = 0;
          hour = hour === 12 ? 1 : hour + 1;
          if (hour === 12) ampm = ampm === "AM" ? "PM" : "AM";
        }
        updateTimeDisplay();
      };
      document.getElementById("minDown").onclick = function () {
        min -= 5;
        if (min < 0) {
          min = 55;
          hour = hour === 1 ? 12 : hour - 1;
          if (hour === 11) ampm = ampm === "AM" ? "PM" : "AM";
        }
        updateTimeDisplay();
      };
      // Optional: click hour/min to toggle AM/PM
      ampmDisplay.onclick = function () {
        ampm = ampm === "AM" ? "PM" : "AM";
        updateTimeDisplay();
      };
      updateTimeDisplay();

      // Get input elements
      const sphInput = document.getElementById("driverSPH");
      const tpsInput = document.getElementById("timePerStop");
      const newSphInput = document.getElementById("newSPH");
      const newTpsInput = document.getElementById("newTimePerStop");

      // Track which field was last edited
      let lastEdited = null;

      // When SPH changes, update Time/Stop if SPH is valid
      sphInput.addEventListener("input", function () {
        lastEdited = "sph";
        const sph = parseFloat(sphInput.value);
        if (sph > 0) {
          tpsInput.value = (60 / sph).toFixed(2);
        } else if (!sphInput.value) {
          tpsInput.value = "";
        }
      });

      // When Time/Stop changes, update SPH if Time/Stop is valid
      tpsInput.addEventListener("input", function () {
        lastEdited = "tps";
        const tps = parseFloat(tpsInput.value);
        if (tps > 0) {
          sphInput.value = (60 / tps).toFixed(2);
        } else if (!tpsInput.value) {
          sphInput.value = "";
        }
      });

      // --- Advanced: New SPH/Time autofill ---
      newSphInput.addEventListener("input", function () {
        const sph = parseFloat(newSphInput.value);
        if (sph > 0) {
          newTpsInput.value = (60 / sph).toFixed(2);
        } else if (!newSphInput.value) {
          newTpsInput.value = "";
        }
      });

      newTpsInput.addEventListener("input", function () {
        const tps = parseFloat(newTpsInput.value);
        if (tps > 0) {
          newSphInput.value = (60 / tps).toFixed(2);
        } else if (!newTpsInput.value) {
          newSphInput.value = "";
        }
      });

      const toggleBtn = document.getElementById("toggleAdvanced");
      const advSection = document.getElementById("advancedOptions");
      let advancedMode = false;

      toggleBtn.onclick = function () {
        advancedMode = !advancedMode;
        advSection.style.display = advancedMode ? "block" : "none";
        toggleBtn.textContent = advancedMode
          ? "Hide Advanced Options"
          : "Show Advanced Options";
        // Toggle two-column layout
        document.getElementById("mainInputRow").style.flexDirection =
          advancedMode ? "row" : "column";
        // Toggle SPH/TPS row layout
        const sphTpsRow = document.getElementById("sphTpsRow");
        if (advancedMode) {
          sphTpsRow.classList.remove("flex-row");
        } else {
          sphTpsRow.classList.add("flex-row");
        }
        const mainInputRow = document.getElementById("mainInputRow");
        const leftCol = mainInputRow.children[0];
        const rightCol = mainInputRow.children[1];

        // Get the SPH/TPS columns inside sphTpsRow
        const sphCol = sphTpsRow.children[0];
        const tpsCol = sphTpsRow.children[1];

        if (advancedMode) {
          leftCol.classList.add("lColumn");
          rightCol.classList.add("rColumn");
          // Remove from SPH/TPS fields
          sphCol.classList.remove("lColumn");
          tpsCol.classList.remove("rColumn");
        } else {
          leftCol.classList.remove("lColumn");
          rightCol.classList.remove("rColumn");
          // Re-add to SPH/TPS fields
          sphCol.classList.add("lColumn");
          tpsCol.classList.add("rColumn");
        }
      };

      function calculateFinish() {
        document.getElementById("errorMsg").textContent = "";
        document.getElementById("result").style.display = "none";

        const stops = parseInt(document.getElementById("remainingStops").value);
        const sph = parseFloat(sphInput.value);
        const tps = parseFloat(tpsInput.value);
        const nonDeliveryInput =
          document.getElementById("nonDeliveryTime").value;
        let nonDelivery = 0;
        try {
          nonDelivery =
            eval(nonDeliveryInput.replace(/[^-()\d/*+.]/g, "")) || 0;
        } catch {
          nonDelivery = 0;
        }

        // --- Input Validation ---
        if (!stops || stops < 1) {
          document.getElementById("errorMsg").textContent =
            "Enter remaining stops.";
          return;
        }
        if (lastEdited === "sph" && (!sph || sph <= 0)) {
          document.getElementById("errorMsg").textContent =
            "Enter a valid SPH.";
          return;
        }
        if (lastEdited === "tps" && (!tps || tps <= 0)) {
          document.getElementById("errorMsg").textContent =
            "Enter a valid time per stop.";
          return;
        }
        if (!lastEdited) {
          document.getElementById("errorMsg").textContent =
            "Enter SPH or time per stop.";
          return;
        }
        if (nonDelivery < 0) {
          document.getElementById("errorMsg").textContent =
            "Return drive time cannot be negative.";
          return;
        }

        // --- Advanced Option Parsing ---
        const stopsBefore = advancedMode
          ? parseInt(document.getElementById("stopsBeforeChange").value) || 0
          : 0;
        const newSPH = advancedMode
          ? parseFloat(document.getElementById("newSPH").value) || 0
          : 0;
        const newTPS = advancedMode
          ? parseFloat(document.getElementById("newTimePerStop").value) || 0
          : 0;
        // --- Delivery Time Calculation ---
        if (advancedMode && stopsBefore > 0) {
          const stops1 = Math.min(stops, stopsBefore);
          const stops2 = Math.max(0, stops - stopsBefore);
          if (lastEdited === "sph") {
            deliveryMinutes += (stops1 / sph) * 60;
            deliveryMinutes += (stops2 / (newSPH > 0 ? newSPH : sph)) * 60;
          } else if (lastEdited === "tps") {
            deliveryMinutes += stops1 * tps;
            deliveryMinutes += stops2 * (newTPS > 0 ? newTPS : tps);
          }
        } else if (
          advancedMode &&
          ((lastEdited === "sph" && newSPH > 0) ||
            (lastEdited === "tps" && newTPS > 0))
        ) {
          if (lastEdited === "sph") {
            deliveryMinutes = (stops / newSPH) * 60;
          } else if (lastEdited === "tps") {
            deliveryMinutes = stops * newTPS;
          }
        } else {
          if (lastEdited === "sph") {
            deliveryMinutes = (stops / sph) * 60;
          } else if (lastEdited === "tps") {
            deliveryMinutes = stops * tps;
          }
        }

        // --- Finish Time Calculation ---
        const totalMinutesNeeded = Math.ceil(deliveryMinutes + nonDelivery);

        // Calculate finish time (assume calculation is for "now")
        const now = new Date();
        let finish = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate(),
          now.getHours(),
          now.getMinutes()
        );
        finish.setMinutes(finish.getMinutes() + totalMinutesNeeded);

        const { h: retHour, m: retMin } = getReturnTime24();
        let requiredReturn = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate(),
          retHour,
          retMin
        );

        // Output
        let finishHour = finish.getHours() % 12 || 12;
        let finishMin = pad(finish.getMinutes());
        let finishPeriod = finish.getHours() < 12 ? "AM" : "PM";
        let finishStr = `${finishHour}:${finishMin} ${finishPeriod}`;
        let resultDiv = document.getElementById("result");
        // --- Stops Possible & Rescue Calculation ---
        let willFinish = finish <= requiredReturn;
        let availableMinutes = (requiredReturn - now) / 60000 - nonDelivery;
        if (availableMinutes < 0) availableMinutes = 0;
        let stopsPossible = stops;
        if (!willFinish) {
          if (advancedMode && stopsBefore > 0) {
            // Split available minutes into two segments for two rates
            const minutes1 =
              stopsBefore * (lastEdited === "sph" ? 60 / sph : tps);
            if (availableMinutes < minutes1) {
              // Not enough time for all first-rate stops
              if (lastEdited === "sph" && sph > 0) {
                stopsPossible = Math.floor(sph * (availableMinutes / 60));
              } else if (lastEdited === "tps" && tps > 0) {
                stopsPossible = Math.floor(availableMinutes / tps);
              }
            } else {
              // Enough time for first-rate stops, use second rate for remainder
              const minutes2 = availableMinutes - minutes1;
              let stops2 = 0;
              if (lastEdited === "sph") {
                stops2 = Math.floor(
                  (newSPH > 0 ? newSPH : sph) * (minutes2 / 60)
                );
              } else if (lastEdited === "tps") {
                stops2 = Math.floor(minutes2 / (newTPS > 0 ? newTPS : tps));
              }
              stopsPossible = stopsBefore + stops2;
            }
          } else if (
            advancedMode &&
            ((lastEdited === "sph" && newSPH > 0) ||
              (lastEdited === "tps" && newTPS > 0))
          ) {
            // Use new rate for all stops if provided
            if (lastEdited === "sph") {
              stopsPossible = Math.floor(newSPH * (availableMinutes / 60));
            } else if (lastEdited === "tps") {
              stopsPossible = Math.floor(availableMinutes / newTPS);
            }
          } else {
            // Use main rate for all stops
            if (lastEdited === "sph" && sph > 0) {
              stopsPossible = Math.floor(sph * (availableMinutes / 60));
            } else if (lastEdited === "tps" && tps > 0) {
              stopsPossible = Math.floor(availableMinutes / tps);
            }
          }
        }

        // --- Output Rendering ---
        let total = stops > 0 ? stops : 1;
        let possiblePct = Math.max(
          0,
          Math.min(100, (stopsPossible / total) * 100)
        );
        let rescuePct = Math.max(
          0,
          Math.min(100, ((stops - stopsPossible) / total) * 100)
        );
        let needingRescue = stops - stopsPossible;
        let requiredTimePerStop =
          availableMinutes > 0 && stops > 0 ? availableMinutes / stops : 0;
        let avgStopHr =
          requiredTimePerStop > 0
            ? (60 / requiredTimePerStop).toFixed(2)
            : "N/A";

        resultDiv.innerHTML = `
  <div class="centered">
    <div>Will Finish by <strong>${`${hour}:${pad(min)} ${ampm}`}</strong>?</div>
    <div style="margin: 6px 0 10px 0; font-size: 1.2em;">
      ${
        willFinish
          ? '<span style="color:green;font-weight:bold;">Yes</span>'
          : '<span style="color:orange;font-weight:bold;">No</span>'
      }
    </div>
  </div>
  <div class="bar-labels">
    <span>Stops Possible</span>
    <span>Needing Rescue</span>
  </div>
  <div class="result-bar">
    <div class="bar-possible" style="width:${possiblePct}%;">
      ${stopsPossible}
    </div>
    <div class="bar-rescue" style="width:${rescuePct}%;">
      ${needingRescue > 0 ? needingRescue : ""}
    </div>
  </div>
  <div style="margin-top: 10px;">
    <div>Estimated finish time: <strong>${finishStr}</strong></div>
    <div>Time at stop to finish (min): <strong>${
      requiredTimePerStop > 0 ? requiredTimePerStop.toFixed(2) : "N/A"
    }</strong></div>
    <div>Avg Stop / Hr to finish: <strong>${avgStopHr}</strong></div>
  </div>
`;
        resultDiv.style.display = "block";
      }
    </script>
  </body>
</html>
